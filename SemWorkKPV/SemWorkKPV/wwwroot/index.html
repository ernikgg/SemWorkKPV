<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Markdown Preview</title>

    <style>
        :root {
            --bg: #ffffff;
            --fg: #000000;
            --border: #dddddd;
            --panel: #f9f9f9;
            --button-bg: #eeeeee;
            --button-fg: #000000;
            --accent: #3b82f6;
        }

        body.dark {
            --bg: #121212;
            --fg: #eaeaea;
            --border: #333333;
            --panel: #1e1e1e;
            --button-bg: #2a2a2a;
            --button-fg: #eaeaea;
            --accent: #60a5fa;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 20px;
            background: var(--bg);
            color: var(--fg);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        textarea {
            width: 100%;
            height: 70vh;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 14px;
            background: var(--panel);
            color: var(--fg);
            border: 1px solid var(--border);
            padding: 12px;
            resize: none;
        }

        input {
            padding: 8px 10px;
            background: var(--panel);
            color: var(--fg);
            border: 1px solid var(--border);
        }

        button {
            padding: 8px 12px;
            background: var(--button-bg);
            color: var(--button-fg);
            border: 1px solid var(--border);
            cursor: pointer;
            border-radius: 4px;
        }

            button:hover {
                background: var(--accent);
                color: #ffffff;
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        .preview {
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 12px;
            height: 70vh;
            overflow: auto;
            line-height: 1.5;
            white-space: pre-wrap;
        }

            .preview h1 {
                font-size: 2.2em;
                font-weight: 800;
                margin: 0.6em 0;
            }

            .preview h2 {
                font-size: 1.7em;
                font-weight: 800;
                margin: 0.7em 0;
            }

            .preview h3 {
                font-size: 1.35em;
                font-weight: 700;
                margin: 0.8em 0;
            }

            .preview p {
                margin: 0.5em 0;
            }

            .preview strong {
                font-weight: 700;
            }

            .preview em {
                font-style: italic;
            }

            .preview code {
                background: rgba(127, 127, 127, 0.15);
                padding: 2px 4px;
                border-radius: 4px;
                font-family: ui-monospace, monospace;
            }

        #status {
            opacity: 0.8;
            font-size: 0.9em;
        }

        #docs button {
            width: 100%;
            text-align: left;
        }
    </style>
</head>

<body>
    <h2>Markdown → HTML</h2>

    <!-- Панель управления -->
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <input id="title" placeholder="Title" />
        <button id="btnNew">New</button>
        <button id="btnRender">Render</button>
        <button id="btnSave">Save</button>

        <!-- ✅ Кнопка темы должна быть в HTML, а не в <script> -->
        <button id="btnTheme">🌙 Dark</button>

        <span id="status"></span>
    </div>

    <!-- Авторизация -->
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; margin-bottom:12px;">
        <input id="loginUser" placeholder="username" />
        <input id="loginPass" type="password" placeholder="password" />
        <button id="btnRegister">Register</button>
        <button id="btnLogin">Login</button>
        <button id="btnLogout">Logout</button>
        <span id="authStatus"></span>
    </div>

    <!-- Список документов -->
    <div style="margin-top:12px;">
        <b>Documents</b>
        <div id="docs" style="margin-top:8px;"></div>
    </div>

    <!-- Редактор -->
    <div class="grid" style="margin-top: 12px;">
        <div>
            <p><b>Markdown</b></p>
            <textarea id="md"># Hello

This is **bold** text</textarea>
        </div>

        <div>
            <p><b>Preview</b></p>
            <div class="preview" id="preview"></div>
        </div>
    </div>

    <script>
        // ===== JWT helpers =====
        function getToken() { return localStorage.getItem("token"); }
        function setToken(token) {
            if (token) localStorage.setItem("token", token);
            else localStorage.removeItem("token");
        }
        function authHeaders() {
            const t = getToken();
            return t ? { "Authorization": "Bearer " + t } : {};
        }

        // ===== DOM =====
        const btnNew = document.getElementById('btnNew');
        const btnRender = document.getElementById('btnRender');
        const btnSave = document.getElementById('btnSave');
        const btnTheme = document.getElementById('btnTheme');

        const titleInput = document.getElementById('title');
        const md = document.getElementById('md');
        const preview = document.getElementById('preview');
        const docs = document.getElementById('docs');
        const status = document.getElementById('status');

        const loginUser = document.getElementById('loginUser');
        const loginPass = document.getElementById('loginPass');
        const btnRegister = document.getElementById('btnRegister');
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const authStatus = document.getElementById('authStatus');

        // ===== State =====
        let currentId = null;
        let dirty = false;
        let isSaving = false;
        let lastSavedAt = null;

        const AUTOSAVE_MS = 7000;

        function setStatus(text) { status.textContent = text ?? ''; }
        function setAuthStatus(text) { authStatus.textContent = text ?? ''; }
        function isAuthed() { return !!getToken(); }

        function markDirty() {
            if (!isAuthed()) return;
            dirty = true;
            setStatus('Unsaved');
        }

        function markSaved() {
            dirty = false;
            lastSavedAt = new Date();
            setStatus('Saved at ' + lastSavedAt.toLocaleTimeString());
        }

        function requireAuthUI() {
            docs.textContent = '(login required)';
        }

        function setUiAuthedState() {
            const authed = isAuthed();
            btnNew.disabled = !authed;
            btnSave.disabled = !authed;
            btnRender.disabled = false;

            if (!authed) {
                currentId = null;
                requireAuthUI();
                setAuthStatus('Not logged in');
            } else {
                setAuthStatus('Logged in');
            }
        }

        // ✅ подписки после объявления markDirty
        titleInput.addEventListener('input', markDirty);
        md.addEventListener('input', markDirty);

        // ===== Theme =====
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
                btnTheme.textContent = '☀️ Light';
            } else {
                document.body.classList.remove('dark');
                btnTheme.textContent = '🌙 Dark';
            }
            localStorage.setItem('theme', theme);
        }

        btnTheme.addEventListener('click', () => {
            const isDark = document.body.classList.contains('dark');
            setTheme(isDark ? 'light' : 'dark');
        });

        // ===== AUTH API =====
        async function register() {
            setAuthStatus('Registering...');
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userName: (loginUser.value || '').trim(),
                    password: (loginPass.value || '')
                })
            });

            if (!res.ok) {
                setAuthStatus('Register failed: ' + await res.text());
                return;
            }
            setAuthStatus('Registered. Now login.');
        }

        async function login() {
            setAuthStatus('Logging in...');
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userName: (loginUser.value || '').trim(),
                    password: (loginPass.value || '')
                })
            });

            if (!res.ok) {
                setAuthStatus('Login failed: ' + await res.text());
                return;
            }

            const data = await res.json();
            setToken(data.token);

            const name = data?.user?.userName ?? (loginUser.value || '').trim();
            setAuthStatus('Logged in as ' + name);

            setUiAuthedState();
            await loadDocs();
        }

        function logout() {
            setToken(null);
            setAuthStatus('Logged out');
            setUiAuthedState();
            requireAuthUI();
        }

        btnRegister.addEventListener('click', register);
        btnLogin.addEventListener('click', login);
        btnLogout.addEventListener('click', logout);

        // ===== MARKDOWN RENDER =====
        async function render() {
            const res = await fetch('/api/markdown/render', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ markdown: md.value })
            });

            if (!res.ok) {
                preview.textContent = 'Error: ' + res.status + '\n' + await res.text();
                return;
            }

            const html = await res.text();
            preview.innerHTML = html; // без принудительных <br/>
        }

        // ===== DOCUMENTS API =====
        async function loadDocs() {
            if (!isAuthed()) {
                requireAuthUI();
                return;
            }

            const res = await fetch('/api/documents', { headers: { ...authHeaders() } });

            if (res.status === 401 || res.status === 403) {
                setAuthStatus('Session expired. Please login again.');
                setToken(null);
                setUiAuthedState();
                requireAuthUI();
                return;
            }

            if (!res.ok) {
                setStatus('Failed to load documents: ' + res.status);
                return;
            }

            const list = await res.json();
            docs.innerHTML = '';

            if (!Array.isArray(list) || list.length === 0) {
                docs.textContent = '(empty)';
                return;
            }

            for (const d of list) {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.gap = '8px';
                row.style.marginBottom = '6px';
                row.style.alignItems = 'center';

                const openBtn = document.createElement('button');
                openBtn.textContent = `#${d.id} ${d.title}`;
                openBtn.onclick = () => openDoc(d.id);

                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.onclick = () => deleteDoc(d.id);

                row.appendChild(openBtn);
                row.appendChild(delBtn);
                docs.appendChild(row);
            }
        }

        async function openDoc(id) {
            if (!isAuthed()) { requireAuthUI(); return; }

            const res = await fetch(`/api/documents/${id}`, { headers: { ...authHeaders() } });

            if (res.status === 401 || res.status === 403) {
                setAuthStatus('Unauthorized. Please login.');
                setToken(null);
                setUiAuthedState();
                requireAuthUI();
                return;
            }

            if (!res.ok) {
                setStatus('Open failed: ' + res.status);
                return;
            }

            const d = await res.json();
            currentId = d.id;
            dirty = false;

            titleInput.value = d.title ?? '';
            md.value = d.markdown ?? '';

            await render();
            setStatus(`Opened #${d.id}`);
        }

        async function deleteDoc(id) {
            if (!isAuthed()) { requireAuthUI(); return; }

            const res = await fetch(`/api/documents/${id}`, {
                method: 'DELETE',
                headers: { ...authHeaders() }
            });

            if (res.status === 401 || res.status === 403) {
                setAuthStatus('Unauthorized. Please login.');
                setToken(null);
                setUiAuthedState();
                requireAuthUI();
                return;
            }

            if (!res.ok) {
                setStatus('Delete failed: ' + res.status + '\n' + await res.text());
                return;
            }

            if (currentId === id) newDoc();
            await loadDocs();
            setStatus(`Deleted #${id}`);
        }

        function newDoc() {
            currentId = null;
            dirty = false;
            titleInput.value = '';
            md.value = '# Hello\n\nWrite here...';
            preview.innerHTML = '';
            setStatus('New document');
        }

        window.addEventListener('beforeunload', (e) => {
            if (!dirty) return;
            e.preventDefault();
            e.returnValue = '';
        });

        async function saveDoc() {
            if (isSaving) return;

            if (!isAuthed()) {
                setAuthStatus('Login required to save.');
                requireAuthUI();
                return;
            }

            isSaving = true;
            setStatus('Saving...');

            try {
                await render();

                const payload = {
                    title: titleInput.value || 'Untitled',
                    markdown: md.value
                };

                if (currentId === null) {
                    const res = await fetch('/api/documents', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(payload)
                    });

                    if (res.status === 401 || res.status === 403) {
                        setAuthStatus('Unauthorized. Please login.');
                        setToken(null);
                        setUiAuthedState();
                        requireAuthUI();
                        return;
                    }

                    if (!res.ok) {
                        setStatus('Save failed: ' + res.status + '\n' + await res.text());
                        return;
                    }

                    const created = await res.json();
                    currentId = created.id;
                    setStatus(`Saved new #${currentId}`);
                } else {
                    const res = await fetch(`/api/documents/${currentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify(payload)
                    });

                    if (res.status === 401 || res.status === 403) {
                        setAuthStatus('Unauthorized. Please login.');
                        setToken(null);
                        setUiAuthedState();
                        requireAuthUI();
                        return;
                    }

                    if (!res.ok) {
                        setStatus('Update failed: ' + res.status + '\n' + await res.text());
                        return;
                    }

                    setStatus(`Updated #${currentId}`);
                }

                await loadDocs();
                markSaved();
            } finally {
                isSaving = false;
            }
        }

        btnNew.addEventListener('click', () => { newDoc(); render(); });
        btnRender.addEventListener('click', render);
        btnSave.addEventListener('click', saveDoc);

        setInterval(async () => {
            if (!isAuthed()) return;
            if (!dirty) return;
            if (isSaving) return;
            if (!md.value || md.value.trim().length === 0) return;
            await saveDoc();
        }, AUTOSAVE_MS);

        // ===== init =====
        (async () => {
            // theme init
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);

            setUiAuthedState();

            if (isAuthed()) await loadDocs();
            else requireAuthUI();

            newDoc();
            await render();
        })();
    </script>
</body>
</html>
